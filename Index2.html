<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
		<!-- Define the title of the page -->
		<title>About Us</title>

		
		<script type="text/javascript">
function readWriteNfc() {
	//alert('test');
/*  if ('nfc' in navigator) {
    navigator.nfc.watch(function (message) {
        consoleLog("NFC message received from URL " + message.url);
        if (message.data[0].recordType === 'empty') {
          navigator.nfc.push([{
            url: message.url,
            data: [{
              recordType: "text",
              data: 'Hello World'
            }]
          }]);
        }
        processMessage(message);
      })
      .then(() => consoleLog("Added a watch."))
      .catch(err => consoleLog("Adding watch failed: " + err.name));
  } else {
    consoleLog('NFC API not supported.');
  }*/
	navigator.nfc.watch((message) => {
	  if (message.records[0].recordType == 'empty') {
	    navigator.nfc.push({
	      url: "/custom/path",
	      records: [{ recordType: "text", data: 'Hello World' }]
	    });
	  } else {
	    console.log('Read message written by ' + message.url);
	    processMessage(message);
	  }
	}).then(() => {
	  console.log("Added a watch.");
	}).catch((error) => {
	  console.log("Adding watch failed: " + error.name);
	});
}

function consoleLog(data) {
  //var logElement = document.getElementById('log');
  //logElement.innerHTML += '\n' + data;
  alert(data);
}

/*function processMessage(message) {
  message.data.forEach(function (record) {
    if (record.recordType == "string") {
      consoleLog('Data is string: ' + record.data);
    } else if (record.recordType == "json") {
      processJSON(record.data);
    } else if (record.recordType == "url") {
      consoleLog("Data is URL: " + record.data);
    } else if (record.recordType == "opaque" && record.mediaType == 'image/png') {
      processPng(record.data);
    };
  });
}*/
			
function processMessage(message) {
  for (let record of message.records) {
    switch (record.recordType) {
      case "text":
        consoleLog('Data is text: ' + record.data);
        break;
      case "url":
        consoleLog('Data is URL: ' + record.data);
        break;
      case "json":
        processJSON(record.data);
        break;
      case "opaque":
        if (record.mediaType == 'image/png') {
          var img = document.createElement("img");
          img.src = URL.createObjectURL(new Blob([record.data], {type: record.mediaType}));
          document.body.appendChild(img);
          img.onload = function() {
            window.URL.revokeObjectURL(this.src);
          };
        }
        break;
    }
  }
}

function processPng(data) {
  consoleLog("Known image/png data");

  var img = document.createElement("img");
  img.src = URL.createObjectURL(new Blob(data, 'image/png'));
  img.onload = function () {
    window.URL.revokeObjectURL(this.src);
  };
};

function processJSON(data) {
  var obj = JSON.parse(data);
  consoleLog("JSON data: " + obj.myProperty.toString());
};
		</script>		
		
		
	</head>
<body>
<p>
  <button class="btn btn-lg btn-default" onclick="readWriteNfc()">Test NFC Read/Write</button>
</p>

<pre id="log"></pre>

<p><small>Based on the code snippets from <a href="https://w3c.github.io/web-nfc/#examples">specification draft</a>.</small></p>
</body>
</html>
